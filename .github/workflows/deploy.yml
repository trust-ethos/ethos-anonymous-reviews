name: Deploy
on:
  push:
    branches: main
  pull_request:
    branches: main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      id-token: write # Needed for auth with Deno Deploy
      contents: read # Needed to clone the repository

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Install Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Verify repository structure
        run: |
          echo "📁 Repository structure:"
          ls -la
          echo "📄 Main files exist check:"
          test -f main.ts && echo "✅ main.ts exists" || echo "❌ main.ts missing"
          test -f fresh.gen.ts && echo "✅ fresh.gen.ts exists" || echo "❌ fresh.gen.ts missing"
          test -f fresh.config.ts && echo "✅ fresh.config.ts exists" || echo "❌ fresh.config.ts missing"
          test -f deno.json && echo "✅ deno.json exists" || echo "❌ deno.json missing"

      - name: Cache dependencies
        timeout-minutes: 5
        run: |
          echo "🔄 Caching Deno dependencies..."
          deno cache deno.json
          echo "✅ Dependencies cached"

      - name: Type check
        timeout-minutes: 3
        run: |
          echo "🔍 Type checking..."
          deno check --unstable-kv main.ts
          echo "✅ Type check passed"

      - name: Build step
        timeout-minutes: 8
        run: |
          echo "🔨 Building application..."
          deno task build
          echo "✅ Build completed"
          echo "📁 Build output:"
          ls -la _fresh/ || echo "No _fresh directory found"

      - name: Deploy to Deno Deploy
        timeout-minutes: 8
        uses: denoland/deployctl@v1
        with:
          project: "ethos-anonymous-reviews"
          entrypoint: "main.ts"
          root: "."
